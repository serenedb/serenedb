name: SereneDB-Build-Base
# TODO: how to strip keeping the debug symbols?
# TODO: Add or update step uploading artifacts

on:
  workflow_call:
    inputs:
      PRESET:
        description: 'Build preset'
        type: string
        required: true
        default: 'build'
      LOCATION:
        description: 'Where the load is executed'
        type: string
        required: true
        default: 'self-hosted'
      BRANCH:
        description: 'SereneDB branch to test'
        type: string
        required: true
        default: 'main'
      JOB_CONFIG:
        description: 'JSON config for job settings'
        type: string
        required: false
        default: '{"CLUSTER_BRANCH":"main","BUILD_IMAGE":"registry.serenedb.com:5000/serenedb-build-ubuntu:latest","SDB_CLUSTER":"Off","DEBUG_PRINT_ENV":"false"}'
      DOCKER_SERENEDB_IMAGE:
        description: 'Produce SereneDB Docker Images'
        required: true
        type: boolean
        default: false
      DOCKER_EXTRA_TAGS:
        description: '(Optional) Custom TAGS for DOCKER_SERENEDB_IMAGE'
        required: false
        type: string
        default: ''
      PUSH_IMAGES_2_REGISTRY:
        description: 'Push images to Private Docker Registry'
        required: true
        type: boolean
        default: false
      EXTRA_ARTIFACTS:
        description: 'Keep these artifacts additionally'
        type: string
        required: false
        default: ''
      DOCKER_BUILD_IMAGES:
        description: 'Produce SereneDB Build Images'
        required: true
        type: boolean
        default: false
      BUILD_CONFIG:
        description: 'Backup JSON configuration for builds'
        type: string
        required: false
        default: '{}'
    secrets:
      PAT_TOKEN:
        required: true
      SDB_CLUSTER_REPO:
        required: true
      TG_TOKEN:
        required: true
      TG_CHAT_ID:
        required: true
      TG_THREAD_ID_BUILD:
        required: true
      TG_THREAD_ID_MAIN:
        required: true
      TG_USER_MAP:
        required: true

env:
  WORKSPACE: ${{ github.workspace }}
  BUILD_CONFIG: ${{ inputs.build_config || '{}' }}
  DOCKER_EXTRA_TAGS: ${{ inputs.DOCKER_EXTRA_TAGS }}
  DOCKER_SERENEDB_IMAGE: ${{ inputs.DOCKER_SERENEDB_IMAGE }} 
  DOCKER_BUILD_IMAGES: ${{ inputs.DOCKER_BUILD_IMAGES }}
  # Job config environment (from JOB_CONFIG JSON)
  CLUSTER_BRANCH: ${{ fromJSON(inputs.JOB_CONFIG).CLUSTER_BRANCH }}
  BUILD_IMAGE: ${{ fromJSON(inputs.JOB_CONFIG).BUILD_IMAGE }}
  SDB_CLUSTER: ${{ fromJSON(inputs.JOB_CONFIG).SDB_CLUSTER }}
  DEBUG_PRINT_ENV: ${{ fromJSON(inputs.JOB_CONFIG).DEBUG_PRINT_ENV }}

  #BRANCH: ${{ inputs.BRANCH }}
  #CLUSTER_BRANCH: ${{ inputs.CLUSTER_BRANCH }}
  #EXTRA_ARTIFACTS: ${{ inputs.EXTRA_ARTIFACTS }}
  #LOCATION: ${{ inputs.LOCATION }}
  #PUSH_IMAGES_2_REGISTRY: ${{ inputs.PUSH_IMAGES_2_REGISTRY }}
  #STRIP_TARBALL: ${{ inputs.STRIP_TARBALL }}
  #WORKFLOW: ${{ github.workflow }}

jobs:
  build-test-package:
    name: Build, Test & Package
    runs-on:
      - self-hosted
      - ${{ inputs.LOCATION }}

    steps:
      # ==================== CHECKOUT ====================
      - name: Load preset & fix git
        run: |
          case "${{ inputs.PRESET }}" in
            asan)
              echo "ENABLE_GTEST_BUILD=true" >> $GITHUB_ENV
              echo "ENABLE_TEST_BUILD=true" >> $GITHUB_ENV
              echo "ENABLE_RELEASE_BUILD=false" >> $GITHUB_ENV
              echo "DEB_TAR_PACKAGES=false" >> $GITHUB_ENV
              echo "SANITIZERS=UndefinedAddress" >> $GITHUB_ENV
              echo "USE_COVERAGE=SourceBased" >> $GITHUB_ENV
              ;;
            tsan)
              echo "ENABLE_GTEST_BUILD=true" >> $GITHUB_ENV
              echo "ENABLE_TEST_BUILD=true" >> $GITHUB_ENV
              echo "ENABLE_RELEASE_BUILD=false" >> $GITHUB_ENV
              echo "DEB_TAR_PACKAGES=false" >> $GITHUB_ENV
              echo "SANITIZERS=Thread" >> $GITHUB_ENV
              echo "USE_COVERAGE=SourceBased" >> $GITHUB_ENV
              ;;
            build)
              echo "ENABLE_GTEST_BUILD=true" >> $GITHUB_ENV
              echo "ENABLE_TEST_BUILD=true" >> $GITHUB_ENV
              echo "ENABLE_RELEASE_BUILD=true" >> $GITHUB_ENV
              echo "DEB_TAR_PACKAGES=false" >> $GITHUB_ENV
              echo "SANITIZERS=" >> $GITHUB_ENV
              echo "USE_COVERAGE=" >> $GITHUB_ENV
              ;;
            release)
              echo "ENABLE_GTEST_BUILD=true" >> $GITHUB_ENV
              echo "ENABLE_TEST_BUILD=true" >> $GITHUB_ENV
              echo "ENABLE_RELEASE_BUILD=true" >> $GITHUB_ENV
              echo "DEB_TAR_PACKAGES=true" >> $GITHUB_ENV
              echo "SANITIZERS=" >> $GITHUB_ENV
              echo "USE_COVERAGE=" >> $GITHUB_ENV
              ;;
          esac
          
          BUILD_CONFIG='${{ inputs.BUILD_CONFIG }}'
          if [[ -n "$BUILD_CONFIG" && "$BUILD_CONFIG" != "{}" ]]; then
            echo "$BUILD_CONFIG" | docker run --rm -i ghcr.io/jqlang/jq:1.8.1 -r 'to_entries | .[] | "\(.key)=\(.value)"' >> $GITHUB_ENV
          fi
          
          git config --global --add safe.directory '*'

      - name: Checkout SereneDB
        uses: actions/checkout@v4
        with:
          repository: serenedb/serenedb
          ref: ${{ inputs.BRANCH }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 1
          submodules: true
          clean: true

      - name: Checkout Cluster
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.SDB_CLUSTER_REPO }}
          ref: ${{ env.CLUSTER_BRANCH }}
          token: ${{ secrets.PAT_TOKEN }}
          path: private
          fetch-depth: 1
          submodules: true

      - name: Print environment
        if: env.DEBUG_PRINT_ENV == 'true'
        run: printenv

      - name: Set sanitizer options
        if: inputs.SANITIZERS != '' || inputs.USE_COVERAGE != ''
        run: ./private/ci/steps/01-ci-set-sanitizer-options.bash

      - name: Build Docker environment file
        run: ./private/ci/steps/02-ci-build-docker-env-file.bash

      # ==================== BUILD ====================
      # if selected, DOCKER_BUILD_IMAGES owns the build 
      - name: SereneDB build
        id: serenedb_build
        if: env.DOCKER_BUILD_IMAGES != 'true'
        run: ./private/ci/steps/03-ci-in-docker-build-targets.bash

      # ==================== TESTS ====================
      - name: Run tests in parallel
        id: run_tests
        if: steps.serenedb_build.outcome == 'success'
        run: ./private/ci/steps/04-ci-run-tests-parallel.bash

      # ==================== PACKAGES ====================
      - name: SereneDB Packages
        id: serenedb_packages
        if: steps.serenedb_build.outcome == 'success'
        run: ./private/ci/steps/05-ci-in-docker-package.bash

      # ==================== COVERAGE REPORT ====================
      - name: Generate coverage report
        id: coverage_report
        if: steps.serenedb_build.outcome == 'success' && inputs.USE_COVERAGE != ''
        run: ./private/ci/steps/06-ci-in-docker-generate-coverage-report.bash

      # ==================== BUILD DOCKER IMAGES ====================
      - name: Build Docker Images
        id: build_docker_images
        if: steps.serenedb_packages.outcome == 'success' && env.DOCKER_SERENEDB_IMAGE == 'true'
        working-directory: ./packages
        run: ./build_docker.bash

      # ==================== PRODUCE BUILD IMAGES ====================
      - name: Produce Build Images
        id: produce_build_images
        if: env.DOCKER_BUILD_IMAGES == 'true'
        working-directory: ./private/ci
        run: ./build_images.sh

      # ==================== DETERMINE FINAL STATUS ====================
      - name: Determine final job status
        id: final_status
        if: always() && !cancelled()
        run: |
          HAS_FAILURES=false

          if [[ "${{ steps.serenedb_build.outcome }}" == "failure" ]]; then
            echo "Build failed"
            HAS_FAILURES=true
          fi

          if [[ "${{ steps.run_tests.outcome }}" == "failure" ]]; then
            echo "Tests failed"
            HAS_FAILURES=true
          fi

          if [[ "${{ steps.serenedb_packages.outcome }}" == "failure" ]]; then
            echo "Packages failed"
            HAS_FAILURES=true
          fi

          if [[ "${{ steps.coverage_report.outcome }}" == "failure" ]]; then
            echo "Coverage report generation failed"
            HAS_FAILURES=true
          fi

          if [[ "${{ steps.build_docker_images.outcome }}" == "failure" ]]; then
            echo "Build Docker Images failed"
            HAS_FAILURES=true
          fi

          if [[ "${{ steps.produce_build_images.outcome }}" == "failure" ]]; then
            echo "Produce Build Images failed"
            HAS_FAILURES=true
          fi

          echo "HAS_FAILURES=$HAS_FAILURES" >> $GITHUB_ENV

      # ==================== ARTIFACTS ====================
      - name: Upload build artifacts
        if: always() && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.run_number }}
          path: |
            binaries.tar.gz
            build_description.txt
            cmake*.log
            make*.log
            ccache*.log
            check-log-ids.log
            clang-format.log
            clang-format.diff
            vpack-tests.log
            iresearch-tests.log
            serenedb-tests*.log
            fuerte-tests.log
            tests.log
            testfailures.txt
            testreport-*.tar*
            testRuns.html
            testProtocol.txt
            test.log
            crashreport-*.tar*
            sanitizers/**/*
            build/coverage/**/*
            logs/*
          if-no-files-found: ignore
          retention-days: 30

      - name: Upload extra artifacts
        if: always() && !cancelled() && inputs.EXTRA_ARTIFACTS != ''
        uses: actions/upload-artifact@v4
        with:
          name: extra-artifacts-${{ github.run_number }}
          path: ${{ inputs.EXTRA_ARTIFACTS }}
          if-no-files-found: ignore
          retention-days: 30

      - name: Upload test results
        if: always() && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            **/vpack-tests.xml
            **/iresearch-tests.xml
            **/serenedb-tests*.xml
            **/fuerte-testsXml/*.xml
            **/testrunXml/**/*.xml
            **/tests/sqllogic/*.xml
          if-no-files-found: ignore
          retention-days: 30

      # ==================== CLEANUP ====================
      - name: Update file ownership
        if: always()
        run: ./private/ci/steps/07-ci-in-docker-update-file-ownership.bash

      - name: Docker cleanup
        if: always() && !cancelled()
        run: |
          docker system prune -f || true
          docker volume prune -f || true

      # ==================== TELEGRAM NOTIFICATION ====================
      - name: Send Telegram notification
        if: always() && !cancelled()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TG_THREAD_ID_MAIN: ${{ secrets.TG_THREAD_ID_MAIN }}
          TG_THREAD_ID_BUILD: ${{ secrets.TG_THREAD_ID_BUILD }}
          TG_USER_MAP: ${{ secrets.TG_USER_MAP }}
          BRANCH: ${{ inputs.BRANCH }}
          JOB_STATUS: ${{ env.HAS_FAILURES == 'true' && 'failure' || 'success' }}
          ACTOR: ${{ github.actor }}
          WORKFLOW: ${{ github.workflow }}
          RUN_NUMBER: ${{ github.run_number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: ./scripts/notify_telegram.bash

      # ==================== FAIL JOB IF ANY STAGE FAILED ====================
      - name: Fail job if any stage failed
        if: always() && !cancelled() && env.HAS_FAILURES == 'true'
        run: exit 1
