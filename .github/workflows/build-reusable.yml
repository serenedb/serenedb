name: SereneDB Build (Reusable)

on:
  workflow_call:
    inputs:
      LOCATION:
        description: 'Where the load is executed'
        required: true
        type: string
        default: 'parilka'
      BRANCH:
        description: 'SereneDB branch to test'
        required: true
        type: string
        default: 'main'
      SDB_PRIVATE:
        description: 'Use private branch switch'
        required: true
        type: boolean
        default: false
      SDB_PRIVATE_BRANCH:
        description: 'Name of the private branch to use'
        required: true
        type: string
        default: 'main'
      DOCKER_BUILD_IMAGES:
        description: 'Build images used in build steps'
        required: true
        type: boolean
        default: false
      DOCKER_SERENEDB_IMAGE:
        description: 'Build docker image with SereneDB'
        required: true
        type: boolean
        default: false
      PUSH_IMAGES_2_REGISTRY:
        description: 'Push images to Docker Registry'
        required: true
        type: boolean
        default: false
      DEB_TAR_PACKAGES:
        description: 'Build .deb & .tar.gz packages'
        required: true
        type: boolean
        default: false
      DOCKER_TAG:
        description: 'Custom TAG for DOCKER_SERENEDB_IMAGE'
        required: false
        type: string
        default: ''
      BUILD_IMAGE:
        description: 'Build image to use'
        required: true
        type: string
        default: 'registry.serenedb.com:5000/serenedb-build-ubuntu:latest'
      BUILDMODE:
        description: 'Build mode'
        required: true
        type: string
        default: 'RelWithDebInfo'
      USE_DEBUG_INFO:
        description: 'Debug info mode'
        required: true
        type: string
        default: 'COLUMNS'
      SDB_DEV:
        description: 'SDB Dev mode'
        required: true
        type: string
        default: 'Off'
      USE_IPO:
        description: 'Use IPO'
        required: true
        type: string
        default: 'On'
      SDB_ALLOC:
        description: 'Custom memory allocator'
        required: true
        type: string
        default: 'JE'
      STATIC_EXECUTABLES:
        description: 'Static executables'
        required: true
        type: string
        default: 'On'
      ENSURE_VTUNE_SYMBOLS:
        description: 'VTune symbols (server only)'
        required: true
        type: string
        default: 'Off'
      STRIP_TARBALL:
        description: 'Strip tarball'
        required: true
        type: boolean
        default: true
    secrets:
      TG_TOKEN:
        required: true
      TG_CHAT_ID:
        required: true
      TG_THREAD_ID_BUILD:
        required: true
      TG_THREAD_ID_MAIN:
        required: true
      SDB_PRIVATE_REPO:
        required: true
        description: 'Path to the private repo'
      PRIVATE_ENG_REPO:
        required: true
        description: 'Path to private engine repo'

jobs:
  build:
    name: Build SereneDB
    runs-on: ${{ inputs.LOCATION }}
    timeout-minutes: 180

    env:
      BRANCH: ${{ inputs.BRANCH }}
      SDB_PRIVATE: ${{ inputs.SDB_PRIVATE }}
      SDB_PRIVATE_BRANCH: ${{ inputs.SDB_PRIVATE_BRANCH }}
      DOCKER_BUILD_IMAGES: ${{ inputs.DOCKER_BUILD_IMAGES }}
      DOCKER_SERENEDB_IMAGE: ${{ inputs.DOCKER_SERENEDB_IMAGE }}
      PUSH_IMAGES_2_REGISTRY: ${{ inputs.PUSH_IMAGES_2_REGISTRY }}
      DEB_TAR_PACKAGES: ${{ inputs.DEB_TAR_PACKAGES }}
      DOCKER_TAG: ${{ inputs.DOCKER_TAG }}
      BUILD_IMAGE: ${{ inputs.BUILD_IMAGE }}
      BUILDMODE: ${{ inputs.BUILDMODE }}
      USE_DEBUG_INFO: ${{ inputs.USE_DEBUG_INFO }}
      SDB_DEV: ${{ inputs.SDB_DEV }}
      USE_IPO: ${{ inputs.USE_IPO }}
      SDB_ALLOC: ${{ inputs.SDB_ALLOC }}
      STATIC_EXECUTABLES: ${{ inputs.STATIC_EXECUTABLES }}
      ENSURE_VTUNE_SYMBOLS: ${{ inputs.ENSURE_VTUNE_SYMBOLS }}
      STRIP_TARBALL: ${{ inputs.STRIP_TARBALL }}
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      TG_THREAD_ID_BUILD: ${{ secrets.TG_THREAD_ID_BUILD }}
      TG_THREAD_ID_MAIN: ${{ secrets.TG_THREAD_ID_MAIN }}
      SDB_PRIVATE_REPO: ${{ secrets.SDB_PRIVATE_REPO }}
      PRIVATE_ENG_REPO: ${{ secrets.PRIVATE_ENG_REPO }}

    steps:
      - name: Checkout private repo (sparse - build images only)
        if: env.DOCKER_SERENEDB_IMAGE != 'true' && env.DEB_TAR_PACKAGES != 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SDB_PRIVATE_REPO }}
          ref: ${{ env.SDB_PRIVATE_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: private
          sparse-checkout: |
            ci/build_images.sh
            ci/build-alpine.Dockerfile
            ci/build-ubuntu.Dockerfile
          sparse-checkout-cone-mode: false

      - name: Checkout SereneDB repo
        if: env.DOCKER_SERENEDB_IMAGE == 'true' || env.DEB_TAR_PACKAGES == 'true'
        uses: actions/checkout@v4
        with:
          repository: serenedb/serenedb
          ref: ${{ env.BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          submodules: true
          path: .

      - name: Checkout private repo
        if: env.DOCKER_SERENEDB_IMAGE == 'true' || env.DEB_TAR_PACKAGES == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SDB_PRIVATE_REPO }}
          ref: ${{ env.SDB_PRIVATE_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          submodules: true
          path: private

      - name: Checkout private engine repo
        if: env.DOCKER_SERENEDB_IMAGE == 'true' || env.DEB_TAR_PACKAGES == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PRIVATE_ENG_REPO }}
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          submodules: true
          path: third_party/v8-build

      - name: Print environment
        run: printenv | sort

      - name: Build Images
        if: env.DOCKER_BUILD_IMAGES == 'true'
        working-directory: ./private/ci
        run: ./build_images.sh

      - name: Build SereneDB & Packages
        if: env.DOCKER_SERENEDB_IMAGE == 'true' || env.DEB_TAR_PACKAGES == 'true'
        run: |
          cat > ./docker.env << EOF
          DEB_TAR_PACKAGES=${{ env.DEB_TAR_PACKAGES }}
          BUILDMODE=${{ env.BUILDMODE }}
          USE_DEBUG_INFO=${{ env.USE_DEBUG_INFO }}
          SDB_DEV=${{ env.SDB_DEV }}
          USE_IPO=${{ env.USE_IPO }}
          SDB_ALLOC=${{ env.SDB_ALLOC }}
          SDB_PRIVATE=${{ env.SDB_PRIVATE }}
          ENSURE_VTUNE_SYMBOLS=${{ env.ENSURE_VTUNE_SYMBOLS }}
          STRIP_TARBALL=${{ env.STRIP_TARBALL }}
          STATIC_EXECUTABLES=${{ env.STATIC_EXECUTABLES }}
          RUNNER_ID=$(id -u):$(id -g)
          EOF
          
          echo "=== Docker environment file ==="
          cat ./docker.env
          echo "==============================="
          
          docker run --rm \
            --cap-add=SYS_PTRACE \
            --privileged \
            --security-opt seccomp=unconfined \
            --env-file ./docker.env \
            -v ${{ github.workspace }}:/serenedb \
            -v /mnt/data/.ccache:/.ccache \
            ${{ env.BUILD_IMAGE }} /serenedb/private/ci/build_packages.bash

      - name: Build SereneDB Docker Image
        if: env.DOCKER_SERENEDB_IMAGE == 'true'
        working-directory: ./packages
        run: ./build_docker.bash

      - name: Upload DEB packages
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages
          path: "*.deb"
          if-no-files-found: ignore
          retention-days: 30

      - name: Upload TAR.GZ packages
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: tar-packages
          path: "*.tar.gz"
          if-no-files-found: ignore
          retention-days: 30

      - name: Docker cleanup
        if: always()
        run: |
          docker system prune -f || true
          docker volume prune -f || true

      - name: Send Telegram notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            EMOJI="âœ…"
            RESULT="SUCCESS"
          else
            EMOJI="ðŸ’¥"
            RESULT="FAILURE"
          fi

          if [ "${{ env.BRANCH }}" == "main" ]; then
            TOPIC_ID="${{ env.TG_THREAD_ID_MAIN }}"
          else
            TOPIC_ID="${{ env.TG_THREAD_ID_BUILD }}"
          fi

          TEXT="${EMOJI} @${{ github.actor }} ${RESULT}: BRANCH=${{ env.BRANCH }} ${{ github.workflow }} #${{ github.run_number }} ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl --location --request POST "https://api.telegram.org/bot${{ env.TG_TOKEN }}/sendMessage" \
            --form "text=${TEXT}" \
            --form "chat_id=${{ env.TG_CHAT_ID }}" \
            --form "message_thread_id=${TOPIC_ID}" || true

  cleanup:
    name: Cleanup
    needs: build
    runs-on: ${{ inputs.LOCATION }}
    if: always()
    steps:
      - name: Final Docker cleanup
        run: |
          docker system prune -af || true
          docker volume prune -f || true
