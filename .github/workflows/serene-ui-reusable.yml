name: SereneUI Build (Reusable)

on:
    workflow_call:
        inputs:
            LOCATION:
                description: "Where the load is executed"
                required: true
                type: string
                default: "parilka"
            BRANCH:
                description: "SereneDB Client UI branch to test"
                required: true
                type: string
                default: "main"
            BUILD_IMAGE:
                description: "Build SereneUI Docker image"
                required: true
                type: boolean
                default: false
            PUSH_IMAGE_TO_REGISTRY:
                description: "Push SereneUI Docker image to Docker Registry"
                required: true
                type: boolean
                default: false
            RUN_TESTS:
                description: "Run SereneUI screenshot tests"
                required: true
                type: boolean
                default: true
            DOCKER_TAG:
                description: "Custom TAG for SereneUI Docker image"
                required: false
                type: string
                default: "latest"
            BUILD_LINUX_APP:
                description: "Build SereneUI Linux desktop app"
                required: true
                type: boolean
                default: false
            BUILD_WINDOWS_APP:
                description: "Build SereneUI Windows desktop app"
                required: true
                type: boolean
                default: false
            BUILD_MACOS_APP:
                description: "Build SereneUI macOS desktop app"
                required: true
                type: boolean
                default: false
            PUSH_RELEASE:
                description: "Publish desktop app builds as GitHub Release"
                required: true
                type: boolean
                default: false
        secrets:
            TG_TOKEN:
                required: true
            TG_CHAT_ID:
                required: true
            TG_THREAD_ID_BUILD:
                required: true
            TG_THREAD_ID_MAIN:
                required: true

jobs:
    build-docker:
        name: Build Docker Image
        runs-on: ${{ inputs.LOCATION }}
        timeout-minutes: 60

        env:
            BRANCH: ${{ inputs.BRANCH }}
            PUSH_IMAGE_TO_REGISTRY: ${{ inputs.PUSH_IMAGE_TO_REGISTRY }}
            DOCKER_TAG: ${{ inputs.DOCKER_TAG }}
            TG_TOKEN: ${{ secrets.TG_TOKEN }}
            TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
            TG_THREAD_ID_BUILD: ${{ secrets.TG_THREAD_ID_BUILD }}
            TG_THREAD_ID_MAIN: ${{ secrets.TG_THREAD_ID_MAIN }}

        steps:
            - name: Checkout SereneDB repo
              uses: actions/checkout@v4
              with:
                  repository: serenedb/serenedb
                  ref: ${{ env.BRANCH }}
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 1
                  submodules: true
                  path: .

            - name: Print environment
              run: printenv | sort

            - name: Cleanup before build
              working-directory: ./serene-ui
              run: |
                  ./scripts/cleanup.sh || true
                  rm -rf logs
                  mkdir logs

            - name: Run tests
              if: inputs.RUN_TESTS
              working-directory: ./serene-ui
              run: ./scripts/run_tests.sh 2>&1 | tee -a logs/run.log

            - name: Upload test artifacts
              if: always() && inputs.RUN_TESTS
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-test-artifacts-docker
                  path: |
                      serene-ui/screenshots/diff/**/*
                      serene-ui/logs/**/*
                  if-no-files-found: ignore
                  retention-days: 30

            - name: Build Docker image
              if: inputs.BUILD_IMAGE
              working-directory: ./serene-ui
              run: ./scripts/build_docker.sh 2>&1 | tee -a logs/build.log

            - name: Docker cleanup
              if: always()
              working-directory: ./serene-ui
              run: ./scripts/cleanup.sh || true

            - name: Send Telegram notification
              if: always()
              run: |
                  if [ "${{ job.status }}" == "success" ]; then
                    EMOJI="âœ…"
                    RESULT="SUCCESS"
                  else
                    EMOJI="ðŸ’¥"
                    RESULT="FAILURE"
                  fi

                  if [ "${{ env.BRANCH }}" == "main" ]; then
                    TOPIC_ID="${{ env.TG_THREAD_ID_MAIN }}"
                  else
                    TOPIC_ID="${{ env.TG_THREAD_ID_BUILD }}"
                  fi

                  TEXT="${EMOJI} @${{ github.actor }} ${RESULT}: BRANCH=${{ env.BRANCH }} ${{ github.workflow }} #${{ github.run_number }} ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

                  curl --location --request POST "https://api.telegram.org/bot${{ env.TG_TOKEN }}/sendMessage" \
                    --form "text=${TEXT}" \
                    --form "chat_id=${{ env.TG_CHAT_ID }}" \
                    --form "message_thread_id=${TOPIC_ID}" || true

    build-linux-app:
        name: Build Linux App
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - name: Checkout SereneDB repo
              uses: actions/checkout@v4
              with:
                  repository: serenedb/serenedb
                  ref: ${{ inputs.BRANCH }}
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 1
                  submodules: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install dependencies
              working-directory: ./serene-ui
              run: npm ci

            - name: Build shared packages & web app
              working-directory: ./serene-ui
              run: npm run build

            - name: Run tests
              if: inputs.RUN_TESTS
              working-directory: ./serene-ui/apps/web
              run: npm test

            - name: Package Electron app
              if: inputs.BUILD_LINUX_APP
              working-directory: ./serene-ui/apps/electron
              run: npm run package:prod

            - name: Make Electron distributables
              if: inputs.BUILD_LINUX_APP
              working-directory: ./serene-ui/apps/electron
              run: npm run make:prod

            - name: Upload Linux artifacts
              if: inputs.BUILD_LINUX_APP
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-linux
                  path: serene-ui/apps/electron/out/make/**/*
                  if-no-files-found: error
                  retention-days: 30

    build-windows-app:
        name: Build Windows App
        runs-on: windows-latest
        timeout-minutes: 30
        steps:
            - name: Checkout SereneDB repo
              uses: actions/checkout@v4
              with:
                  repository: serenedb/serenedb
                  ref: ${{ inputs.BRANCH }}
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 1
                  submodules: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install dependencies
              working-directory: ./serene-ui
              run: npm ci

            - name: Build shared packages & web app
              working-directory: ./serene-ui
              run: npm run build

            - name: Run tests
              if: inputs.RUN_TESTS
              working-directory: ./serene-ui/apps/web
              run: npm test

            - name: Package Electron app
              if: inputs.BUILD_WINDOWS_APP
              working-directory: ./serene-ui/apps/electron
              run: npm run package:prod

            - name: Make Electron distributables
              if: inputs.BUILD_WINDOWS_APP
              working-directory: ./serene-ui/apps/electron
              run: npm run make:prod

            - name: Upload Windows artifacts
              if: inputs.BUILD_WINDOWS_APP
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-windows
                  path: serene-ui/apps/electron/out/make/**/*
                  if-no-files-found: error
                  retention-days: 30

    build-macos-app:
        name: Build macOS App
        runs-on: macos-latest
        timeout-minutes: 1440
        steps:
            - name: Checkout SereneDB repo
              uses: actions/checkout@v4
              with:
                  repository: serenedb/serenedb
                  ref: ${{ inputs.BRANCH }}
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 1
                  submodules: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install dependencies
              working-directory: ./serene-ui
              run: npm ci

            - name: Build shared packages & web app
              working-directory: ./serene-ui
              run: npm run build

            - name: Run tests
              if: inputs.RUN_TESTS
              working-directory: ./serene-ui/apps/web
              run: npm test

            - name: Package Electron app
              if: inputs.BUILD_MACOS_APP
              working-directory: ./serene-ui/apps/electron
              run: npm run package:prod

            - name: Make Electron distributables
              if: inputs.BUILD_MACOS_APP
              working-directory: ./serene-ui/apps/electron
              run: npm run make:prod

            - name: Upload macOS artifacts
              if: inputs.BUILD_MACOS_APP
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-macos
                  path: serene-ui/apps/electron/out/make/**/*
                  if-no-files-found: error
                  retention-days: 30

    release:
        name: Publish GitHub Release
        needs: [build-linux-app, build-windows-app, build-macos-app]
        if: always() && inputs.PUSH_RELEASE && (inputs.BUILD_LINUX_APP || inputs.BUILD_WINDOWS_APP || inputs.BUILD_MACOS_APP) && !contains(needs.*.result, 'failure')
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Download Linux artifacts
              if: inputs.BUILD_LINUX_APP
              uses: actions/download-artifact@v4
              with:
                  name: serene-ui-linux
                  path: release-assets/linux

            - name: Download Windows artifacts
              if: inputs.BUILD_WINDOWS_APP
              uses: actions/download-artifact@v4
              with:
                  name: serene-ui-windows
                  path: release-assets/windows

            - name: Download macOS artifacts
              if: inputs.BUILD_MACOS_APP
              uses: actions/download-artifact@v4
              with:
                  name: serene-ui-macos
                  path: release-assets/macos

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: serene-ui-v${{ github.run_number }}
                  name: SereneUI Build #${{ github.run_number }}
                  body: |
                      SereneUI desktop app build from branch `${{ inputs.BRANCH }}`.

                      Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                  draft: false
                  prerelease: true
                  files: release-assets/**/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    cleanup:
        name: Cleanup
        runs-on: ${{ inputs.LOCATION }}
        if: always()
        steps:
            - name: Final Docker cleanup
              run: |
                  docker system prune -af || true
                  docker volume prune -f || true
