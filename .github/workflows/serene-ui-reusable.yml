name: SereneUI-Build-Base

on:
    workflow_call:
        inputs:
            BRANCH:
                description: "SereneDB Client UI branch to test"
                required: true
                type: string
                default: "main"
            BUILD_IMAGE:
                description: "Build SereneUI Docker image"
                required: true
                type: boolean
                default: false
            PUSH_IMAGE_TO_REGISTRY:
                description: "Push SereneUI Docker image to Docker Registry"
                required: true
                type: boolean
                default: false
            RUN_TESTS:
                description: "Run SereneUI screenshot tests"
                required: true
                type: boolean
                default: true
            DOCKER_TAG:
                description: "Custom TAG for SereneUI Docker image"
                required: false
                type: string
                default: "latest"
            BUILD_LINUX_APP:
                description: "Build SereneUI Linux desktop app"
                required: true
                type: boolean
                default: false
            BUILD_WINDOWS_APP:
                description: "Build SereneUI Windows desktop app"
                required: true
                type: boolean
                default: false
            BUILD_MACOS_APP:
                description: "Build SereneUI macOS desktop app"
                required: true
                type: boolean
                default: false
            PUSH_RELEASE:
                description: "Publish desktop app builds as GitHub Release"
                required: true
                type: boolean
                default: false
        secrets:
            PAT_TOKEN:
                required: true
                description: "Personal Access Token with repo access"
            TG_TOKEN:
                required: true
            TG_CHAT_ID:
                required: true

jobs:
    build-docker:
        name: Build Docker Image
        if: inputs.RUN_TESTS || inputs.BUILD_IMAGE
        runs-on: X64
        timeout-minutes: 60
        defaults:
            run:
                working-directory: ./serene-ui
        env:
            WORKSPACE: ${{ github.workspace }}
            BRANCH: ${{ inputs.BRANCH }}
            PUSH_IMAGE_TO_REGISTRY: ${{ inputs.PUSH_IMAGE_TO_REGISTRY }}
            DOCKER_TAG: ${{ inputs.DOCKER_TAG }}
            IMAGE: registry.serenedb.com:5000/serene-ui:${{ inputs.DOCKER_TAG }}
        steps:
            - name: Checkout SereneUI
              uses: actions/checkout@v4
              with:
                  repository: serenedb/serenedb
                  ref: ${{ env.BRANCH }}
                  token: ${{ secrets.PAT_TOKEN }}
                  path: .
                  sparse-checkout: |
                      serene-ui
                      scripts
                  sparse-checkout-cone-mode: true

            - name: Run tests
              if: inputs.RUN_TESTS
              run: |
                  mkdir -p logs
                  ./scripts/run_tests_docker.sh 2>&1 | tee -a logs/run.log

            - name: Update file ownership
              if: always()
              run: |
                  export RUNNER_ID="$(id -u):$(id -g)"
                  bash ./scripts/update_ownership.sh

            - name: Upload test artifacts
              if: inputs.RUN_TESTS
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-test-artifacts-docker
                  path: |
                      serene-ui/screenshots/diff/**/*
                      serene-ui/logs/**/*
                  if-no-files-found: ignore
                  retention-days: 30

            - name: Build Docker image
              if: inputs.BUILD_IMAGE
              run: |
                  docker build --pull --no-cache --tag "$IMAGE" . 2>&1 | tee -a logs/build.log
                  if [ "${{ inputs.PUSH_IMAGE_TO_REGISTRY }}" = "true" ]; then
                    docker push "$IMAGE" 2>&1 | tee -a logs/build.log
                  fi

            - name: Send Telegram notification
              if: always() && !cancelled()
              env:
                  TG_TOKEN: ${{ secrets.TG_TOKEN }}
                  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
                  TG_THREAD_ID_MAIN: "51"
                  TG_THREAD_ID_BUILD: "53"
                  TG_USER_MAP: ${{ secrets.TG_USER_MAP }}
                  BRANCH: ${{ inputs.BRANCH }}
                  JOB_STATUS: ${{ job.status }}
                  ACTOR: ${{ github.actor }}
                  WORKFLOW: ${{ github.workflow }}
                  RUN_NUMBER: ${{ github.run_number }}
                  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              run: ../scripts/notify_telegram.bash

            - name: Cleanup workspace & Docker
              if: always()
              run: |
                  docker system prune -f 2>/dev/null || true
                  docker volume prune -f 2>/dev/null || true
    build-linux-app:
        name: Build Linux App
        if: inputs.RUN_TESTS || inputs.BUILD_LINUX_APP
        runs-on: ubuntu-latest
        timeout-minutes: 30
        env:
            BRANCH: ${{ inputs.BRANCH }}
        defaults:
            run:
                working-directory: ./serene-ui
        steps:
            - name: Checkout SereneUI
              uses: actions/checkout@v4
              with:
                  repository: serenedb/serenedb
                  ref: ${{ env.BRANCH }}
                  token: ${{ secrets.PAT_TOKEN }}
                  path: .
                  sparse-checkout: |
                      serene-ui
                      scripts
                  sparse-checkout-cone-mode: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install dependencies & build
              run: |
                  rm -f package-lock.json
                  npm install
                  npm run build

            - name: Install Playwright
              if: inputs.RUN_TESTS
              run: npx playwright install --with-deps

            - name: Run tests
              if: inputs.RUN_TESTS
              run: |
                  mkdir -p logs
                  ./scripts/run_tests_native.sh 2>&1 | tee -a logs/run.log

            - name: Upload test artifacts
              if: inputs.RUN_TESTS && !cancelled()
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-test-artifacts-linux
                  path: |
                      serene-ui/screenshots/diff/**/*
                      serene-ui/logs/**/*
                  if-no-files-found: ignore
                  retention-days: 30

            - name: Build Electron distributables
              if: inputs.BUILD_LINUX_APP
              working-directory: ./serene-ui/apps/electron
              run: |
                  npm run package:prod
                  npm run make:prod

            - name: Upload Linux artifacts
              if: inputs.BUILD_LINUX_APP
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-linux
                  path: serene-ui/apps/electron/out/make/**/*
                  if-no-files-found: error
                  retention-days: 30

            - name: Send Telegram notification
              if: always() && !cancelled()
              env:
                  TG_TOKEN: ${{ secrets.TG_TOKEN }}
                  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
                  TG_THREAD_ID_MAIN: "51"
                  TG_THREAD_ID_BUILD: "53"
                  TG_USER_MAP: ${{ secrets.TG_USER_MAP }}
                  BRANCH: ${{ inputs.BRANCH }}
                  JOB_STATUS: ${{ job.status }}
                  ACTOR: ${{ github.actor }}
                  WORKFLOW: ${{ github.workflow }}
                  RUN_NUMBER: ${{ github.run_number }}
                  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              run: ../scripts/notify_telegram.bash

    build-windows-app:
        name: Build Windows App
        if: inputs.RUN_TESTS || inputs.BUILD_WINDOWS_APP
        runs-on: windows-latest
        timeout-minutes: 30
        env:
            BRANCH: ${{ inputs.BRANCH }}
        defaults:
            run:
                shell: bash
                working-directory: ./serene-ui
        steps:
            - name: Checkout SereneUI
              uses: actions/checkout@v4
              with:
                  repository: serenedb/serenedb
                  ref: ${{ env.BRANCH }}
                  token: ${{ secrets.PAT_TOKEN }}
                  path: .
                  sparse-checkout: |
                      serene-ui
                      scripts
                  sparse-checkout-cone-mode: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install dependencies & build
              run: |
                  rm -f package-lock.json
                  npm install
                  npm run build

            - name: Install Playwright
              if: inputs.RUN_TESTS
              run: npx playwright install

            - name: Run tests
              if: inputs.RUN_TESTS
              run: |
                  mkdir -p logs
                  ./scripts/run_tests_native.sh 2>&1 | tee -a logs/run.log

            - name: Upload test artifacts
              if: inputs.RUN_TESTS && !cancelled()
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-test-artifacts-windows
                  path: |
                      serene-ui/screenshots/diff/**/*
                      serene-ui/logs/**/*
                  if-no-files-found: ignore
                  retention-days: 30

            - name: Build Electron distributables
              if: inputs.BUILD_WINDOWS_APP
              working-directory: ./serene-ui/apps/electron
              run: |
                  npm run package:prod
                  npm run make:prod

            - name: Upload Windows artifacts
              if: inputs.BUILD_WINDOWS_APP
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-windows
                  path: serene-ui/apps/electron/out/make/**/*
                  if-no-files-found: error
                  retention-days: 30

            - name: Send Telegram notification
              if: always() && !cancelled()
              env:
                  TG_TOKEN: ${{ secrets.TG_TOKEN }}
                  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
                  TG_THREAD_ID_MAIN: "51"
                  TG_THREAD_ID_BUILD: "53"
                  TG_USER_MAP: ${{ secrets.TG_USER_MAP }}
                  BRANCH: ${{ inputs.BRANCH }}
                  JOB_STATUS: ${{ job.status }}
                  ACTOR: ${{ github.actor }}
                  WORKFLOW: ${{ github.workflow }}
                  RUN_NUMBER: ${{ github.run_number }}
                  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              run: ../scripts/notify_telegram.bash

    build-macos-app:
        name: Build macOS App
        if: inputs.RUN_TESTS || inputs.BUILD_MACOS_APP
        runs-on: macOS
        timeout-minutes: 1440
        env:
            BRANCH: ${{ inputs.BRANCH }}
        defaults:
            run:
                working-directory: ./serene-ui
        steps:
            - name: Checkout SereneUI
              uses: actions/checkout@v4
              with:
                  repository: serenedb/serenedb
                  ref: ${{ env.BRANCH }}
                  token: ${{ secrets.PAT_TOKEN }}
                  path: .
                  sparse-checkout: |
                      serene-ui
                      scripts
                  sparse-checkout-cone-mode: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install dependencies & build
              run: |
                  rm -f package-lock.json
                  npm install
                  npm run build

            - name: Install Playwright
              if: inputs.RUN_TESTS
              run: npx playwright install --with-deps

            - name: Run tests
              if: inputs.RUN_TESTS
              run: |
                  mkdir -p logs
                  ./scripts/run_tests_native.sh 2>&1 | tee -a logs/run.log

            - name: Upload test artifacts
              if: inputs.RUN_TESTS && !cancelled()
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-test-artifacts-macos
                  path: |
                      serene-ui/screenshots/diff/**/*
                      serene-ui/logs/**/*
                  if-no-files-found: ignore
                  retention-days: 30

            - name: Build Electron distributables
              if: inputs.BUILD_MACOS_APP
              working-directory: ./serene-ui/apps/electron
              run: |
                  npm run package:prod
                  npm run make:prod

            - name: Upload macOS artifacts
              if: inputs.BUILD_MACOS_APP
              uses: actions/upload-artifact@v4
              with:
                  name: serene-ui-macos
                  path: serene-ui/apps/electron/out/make/**/*
                  if-no-files-found: error
                  retention-days: 30

            - name: Send Telegram notification
              if: always() && !cancelled()
              env:
                  TG_TOKEN: ${{ secrets.TG_TOKEN }}
                  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
                  TG_THREAD_ID_MAIN: "51"
                  TG_THREAD_ID_BUILD: "53"
                  TG_USER_MAP: ${{ secrets.TG_USER_MAP }}
                  BRANCH: ${{ inputs.BRANCH }}
                  JOB_STATUS: ${{ job.status }}
                  ACTOR: ${{ github.actor }}
                  WORKFLOW: ${{ github.workflow }}
                  RUN_NUMBER: ${{ github.run_number }}
                  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              run: ../scripts/notify_telegram.bash

              # TODO: (vlaski) add cleanup step
              #
              # TODO: Return Release
