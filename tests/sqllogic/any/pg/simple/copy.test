hash-threshold 100

control substitution on

statement ok
CREATE TABLE tindex
(
  id INTEGER PRIMARY KEY,
  name TEXT
);


statement ok
CREATE TABLE clickclack
(
  id INTEGER PRIMARY KEY,
  name TEXT
);


statement count 3
INSERT INTO tindex VALUES (1, 'vedernikoff'), (2, 'pavelvi'), (3, 'babsky');


statement count 3
COPY tindex TO '/tmp/${__DATABASE__}_quit_low_salary.csv';


statement count 3
COPY clickclack FROM '/tmp/${__DATABASE__}_quit_low_salary.csv';


query
SELECT * FROM clickclack ORDER BY 1, 2;
----
id	name
1	vedernikoff
2	pavelvi
3	babsky


statement count 3
DELETE FROM clickclack;


statement count 2
COPY clickclack FROM '/tmp/${__DATABASE__}_quit_low_salary.csv' WHERE id != 2;


query
SELECT * FROM clickclack ORDER BY 1, 2;
----
id	name
1	vedernikoff
3	babsky


statement count 2
DELETE FROM clickclack;


statement count 1
COPY (SELECT * FROM tindex ORDER BY 1 DESC LIMIT 1) TO '/tmp/${__DATABASE__}_quit_low_salary.csv';


statement count 1
COPY clickclack FROM '/tmp/${__DATABASE__}_quit_low_salary.csv';


query
SELECT * FROM clickclack;
----
id	name
3	babsky


statement count 1
DELETE FROM clickclack;


statement ok
CREATE TABLE reversed
(
  name TEXT PRIMARY KEY,
  id INTEGER
);


statement count 3
COPY tindex TO '/tmp/${__DATABASE__}_lmao' WITH (FORMAT CSV, HEADER TRUE);


statement count 3
COPY reversed(id, name) FROM '/tmp/${__DATABASE__}_lmao' WITH (FORMAT CSV, HEADER TRUE);


query
SELECT * FROM reversed ORDER BY 1, 2;
----
name	id
babsky	3
pavelvi	2
vedernikoff	1


statement count 3
DELETE FROM reversed;


statement count 3
COPY tindex(name, id) TO '/tmp/${__DATABASE__}_lmao';


statement count 3
COPY reversed FROM '/tmp/${__DATABASE__}_lmao';


query
SELECT * FROM reversed ORDER BY 1, 2;
----
name	id
babsky	3
pavelvi	2
vedernikoff	1


statement ok
CREATE TABLE varus
(
  id INTEGER,
  name TEXT,
  iq INTEGER DEFAULT 1000 - 7,
  iamdegenereted INTEGER GENERATED ALWAYS AS (iq + id + 228) STORED
);


statement count 3
COPY varus(name, id) FROM '/tmp/${__DATABASE__}_lmao';


statement count 3
COPY varus(name, id) FROM '/tmp/${__DATABASE__}_lmao';


statement count 3
COPY varus(name, id) FROM '/tmp/${__DATABASE__}_lmao';


query
SELECT * FROM varus ORDER BY 1, 2, 3, 4;
----
id	name	iq	iamdegenereted
1	vedernikoff	993	1222
1	vedernikoff	993	1222
1	vedernikoff	993	1222
2	pavelvi	993	1223
2	pavelvi	993	1223
2	pavelvi	993	1223
3	babsky	993	1224
3	babsky	993	1224
3	babsky	993	1224


statement error
COPY varus(iamdegenereted) FROM '/tmp/${__DATABASE__}_lmao';
----
db error: ERROR: column "iamdegenereted" is a generated column
DETAIL: Generated columns cannot be used in COPY.


statement error
COPY varus(name, id) FROM '/tmp/${__DATABASE__}_lmao' WITH (LABUDABUDABDAB rick);
----
db error: ERROR: option "labudabudabdab" not recognized


statement count 100000
COPY 
(
  SELECT * 
  FROM 
    generate_series(1, 10) as iq, 
    generate_series(1, 100) as pencil_size, 
    generate_series(1, 100) as weight
) TO '/tmp/${__DATABASE__}_arelav' WITH (FORMAT CSV, HEADER 1);


statement ok
CREATE TABLE arelav 
(
  lmao INTEGER,
  kek INTEGER,
  kal INTEGER
);


statement count 100000
COPY arelav FROM '/tmp/${__DATABASE__}_arelav' WITH (FORMAT CSV, HEADER 1);


query
SELECT * FROM arelav ORDER BY 1, 2, 3;
----
300003 values hashing to 568009c5b2055554ab4bd827ebe85b75


statement count 100
COPY 
  (SELECT x, y::text FROM generate_series(1, 10) as g1(x), generate_series(1, 10) as g2(y)) 
TO 
  '/tmp/${__DATABASE__}_deadinside.tsv'
WITH (HEADER TRUE);


statement ok
CREATE TABLE donsimon
(
  vv INTEGER,
  marmishka TEXT
);


statement count 100
COPY donsimon FROM '/tmp/${__DATABASE__}_deadinside.tsv' (ON_ERROR IGNORE, REJECT_LIMIT 1);


query
SELECT * FROM donsimon ORDER BY 1, 2;
----
202 values hashing to 023b58aa7a21f0c2699ccde3252f77b1


statement error
COPY donsimon FROM '/tmp/${__DATABASE__}_deadinside.tsv' (ON_ERROR IGNORE, REJECT_LIMIT -1);
----
db error: ERROR: REJECT_LIMIT (-1) must be greater than zero


statement error
COPY donsimon FROM '/tmp/${__DATABASE__}_deadinside.tsv' (ON_ERROR labudadadab);
----
db error: ERROR: COPY ON_ERROR "labudadadab" not recognized


statement count 10
COPY (SELECT * FROM generate_series(2, 11)) TO '/tmp/${__DATABASE__}_deadinside.tsv';


statement ok
CREATE TABLE biksalen(kek BOOLEAN);


statement error
COPY biksalen FROM '/tmp/${__DATABASE__}_deadinside.tsv' (ON_ERROR IGNORE, REJECT_LIMIT 9);
----
db error: ERROR: skipped more than REJECT_LIMIT (9) rows due to data type incompatibility


statement count 0
COPY biksalen FROM '/tmp/${__DATABASE__}_deadinside.tsv' (ON_ERROR IGNORE, REJECT_LIMIT 10);


statement count 0
COPY biksalen FROM '/tmp/${__DATABASE__}_deadinside.tsv' (ON_ERROR IGNORE);


statement ok
COPY (SELECT * FROM generate_series(2, 11)) TO '/tmp/${__DATABASE__}_deadinside.tsv' WITH (HEADER TRUE);


statement error
COPY biksalen FROM '/tmp/${__DATABASE__}_deadinside.tsv' (ON_ERROR STOP);
----
db error: ERROR: invalid input syntax for type boolean: "generate_series"


statement error
COPY biksalen FROM '/tmp/${__DATABASE__}_deadinside.tsv';
----
db error: ERROR: invalid input syntax for type boolean: "generate_series"


statement error
COPY biksalen FROM '/tmp/${__DATABASE__}_deadinside.tsv' WITH (HEADER ON);
----
db error: ERROR: invalid input syntax for type boolean: "2"


# header check also check that generated key is not inserted
statement ok
CREATE TABLE header_eater (header1 TEXT, header2 TEXT);


statement count 1
COPY (SELECT 1 as header, 2 as header) TO '/tmp/${__DATABASE__}_headers.tsv' WITH (HEADER ON)


statement count 2
COPY header_eater FROM '/tmp/${__DATABASE__}_headers.tsv';
 

query
SELECT * FROM header_eater;
----
header1	header2
header	header
1	2
