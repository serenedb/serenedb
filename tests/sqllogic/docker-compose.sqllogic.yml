services:
  postgres:
    image: postgres:18-alpine
    security_opt:
      - seccomp:unconfined
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
    volumes:
      - type: tmpfs
        target: /var/lib/postgresql
        tmpfs:
          size: 16G
    networks:
      - test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  serenedb-single:
    image: "$BUILD_IMAGE"
    security_opt:
      - seccomp:unconfined
    volumes:
      - "$WORKSPACE:/serenedb"
      - "$WORKSPACE/logs:/var/log/serenedb"
    # It assumes that sanitizers and coverage dirs are created.
    # Executable 'serened' switches to 'serenedb' user. If required dirs are not created,
    # /serenedb dir owner is 'root' and it's impossible for 'serenedb' user to create directory there.
    env_file:
      - "$WORKSPACE/docker.env"
    environment:
      - BUILD_DIR
    networks:
      - test-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/127.0.0.1/7777' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    command: >
        sh -c '
          if ! id serenedb >/dev/null 2>&1; then
            useradd serenedb &&
            chown -R serenedb:serenedb /serenedb/sanitizers /serenedb/${BUILD_DIR}/coverage
          fi &&
          exec /serenedb/${BUILD_DIR}/bin/serened /tmp/serenedb_datadir \
            --server.endpoint pgsql+tcp://0.0.0.0:7777 \
            --server.endpoint tcp://0.0.0.0:8529 \
            --server.authentication 0
        '

  tests:
    image: rust:latest
    volumes:
      - "$SQLLOGIC_DIR:/sqllogic"
      - "$WORKSPACE/third_party/sqllogictest-rs:/sqllogictest-rs"
    depends_on:
      postgres:
        condition: service_healthy
      serenedb-single:
        condition: service_healthy
    networks:
      - test-network
    command: sqllogic/run_serene_and_pg.sh

networks:
  test-network:
    driver: bridge
