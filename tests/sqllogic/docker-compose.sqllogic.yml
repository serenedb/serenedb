services:
  postgres:
    image: postgres:18-alpine
    security_opt:
      - seccomp:unconfined
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
    volumes:
      - type: tmpfs
        target: /var/lib/postgresql/
        tmpfs:
          size: 16G
    networks:
      - test-network

  serenedb-single:
    image: "$BUILD_IMAGE"
    security_opt:
      - seccomp:unconfined
    volumes:
      - "$WORKSPACE:/serenedb"
      - "$WORKSPACE/logs:/var/log/serenedb"
    # It assumes that sanitizers and coverage dirs are created.
    # Executable 'serened' switches to 'serenedb' user. If required dirs are not created,
    # /serenedb dir owner is 'root' and it's impossible for 'serenedb' user to create directory there.
    command: >
        sh -c '
          if ! id serenedb >/dev/null 2>&1; then
            useradd serenedb &&
            chown -R serenedb:serenedb /serenedb/sanitizers /serenedb/build/coverage
          fi &&
          exec /serenedb/build/bin/serened /tmp/serenedb_datadir \
            --server.endpoint pgsql+tcp://0.0.0.0:7777 \
            --server.endpoint tcp://0.0.0.0:8529 \
            --server.authentication 0
        '
    env_file:
      - "$WORKSPACE/docker.env"
    networks:
      - test-network

  tests:
    image: rust:latest
    volumes:
      - "$SQLLOGIC_DIR:/sqllogic"
      - "$WORKSPACE/third_party/sqllogictest-rs:/sqllogictest-rs"
    depends_on:
      - postgres
      - serenedb-single
    command: sqllogic/run_serene_and_pg.sh
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
